version: 2

jobs:
  build:
    docker:
      - image: circleci/python:latest

    steps:
      - checkout
      - run: sudo apt-get update
      - run: sudo apt-get install -y g++ cmake make
      - run: cmake .
      - run: make

  populate_k8s:
    docker:
      - image: circleci/python:latest
    steps:
      - checkout
      - run:
          name: Install AWS CLI
          command: |
            sudo pip install awscli
      - attach_workspace:
          at: kubernetes
      - run:
         name: Download vault
         command: |
           wget https://releases.hashicorp.com/vault/1.1.3/vault_1.1.3_linux_amd64.zip && sudo unzip -d /usr/local/bin vault_1.1.3_linux_amd64.zip
      - run:
         name:  Download kubectl
         command: |
            sudo curl -s -o /usr/local/bin/kubectl -LO https://storage.googleapis.com/kubernetes-release/release/"$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)"/bin/linux/amd64/kubectl
      - run:
         name:  Chmod kubectl
         command: |
             sudo chmod 755 /usr/local/bin/kubectl
      - run:
         name:  test
         command: |
            kubectl get pod

workflows:
  version: 2
  suite:
    jobs:
      - build:
          filters:
            tags:
              only: /.*/
            branches:
              ignore: /.*/
      - populate_k8s:
          filters:
            branches:
              only: /develop/
